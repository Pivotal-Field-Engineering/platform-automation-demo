# platform-automation-example

Example Repository for using platform-automation

## Fly Pipelines

Use the `./scripts/fly-pipelines.sh` script to set and unpause all pipelines.  Optionally, you can view that script to extract the commands to fly or unpause a specific pipeline.  The scirpt assumes you have already logged into concourse.  If not, use `fly -t lab login -k` to login.

## Pipelines Explained

### General Concepts

- Each pipeline leverages locks to ensure that only one pipeline is working on the foundation at any given point.  If a pipeline is triggered while another pipeline has the lock, then it will poll every 1 minute waiting for the lock to be released.  Check out info on the concourse [pool-resource](https://github.com/concourse/pool-resource).  The corresponding lock repository used in my lab is [platform-automation-example-locks](https://github.com/doddatpivotal/platform-automation-example-locks)

### Ops Manager and Director

The ops manager and director pipeline is a single pipeline used for both installation and upgrade of ops manager and director pair.

1. `lock-director` - Claim the lock for the specific foundation.  Waits untile the lock is unclaimed before it progresses.
2. `validate-director-configuration` - Validation the configuration.  Essentially just executing an canary credhub interpolation task which establishes re-usable parameters and ensures secrets are in correct location
3. `install-opsman` - Checks to see if opsman is aready installed.  If so, skips download and creation.  If not does download and installs.  Ensures that the current version is configured as expected and applies changes.  This is so that you don't introduce configuration changes and new version at one time.  If install did occur, then it puts state.yml file in the config directory
4. `export-installation` - Exports the opsmanager and tile configuration and pushes it to s3 bucket
5. `upgrade-opsman` - If existing opsman version is different than current, it will download and upgrade opsman.  Else it will skip.  Will always apply director changes, which will go fast if there were no changes
6. `unlock-director` - Releases the lock on the foundation.

The following notable configuration files exist:

- `state.yml` - Stores an id associated with the opsmanager.  Required for opsman upgrades.  This file must exist and can be blank for an intial install.  The pipeline will update the file after the pipeline is run.  Located in `enviornment/<iaas>/<foundation>/state` folder
- `enviornment/<iaas>/<foundation>/config-director` folder - Contains configuration files used by the pipeline.  Secret mappings are stored in the `secrets` folder and this directory has the credhub interpolate task run against it.
- `...\versions\opsman.yml` contains opsman version information and is where you will bump versions

### Product Tiles

There is a single standard product pipeline configuration that is used for all product tiles.  This enables re-use and consistancy.  Each tile uses the same configuration with a different pipeline name and product variable.  This pipline is used for both installation and upgrade of the tile.

Two groups are defined in the pipeline.  `deployment-pipeline` is the primary pipeline, while `ad-hoc-jobs` contains one-off jobs that can be executed.

Following jobs within the `deployment-pipeline` group

1. `lock-tiles` - Claim the lock for the specific foundation.  Waits untile the lock is unclaimed before it progresses.
2. `validate-tile-configuration` - Validation the configuration.  Essentially just executing an canary credhub interpolation task which establishes re-usable parameters and ensures secrets are in correct location
3. `download-stage-tile-stemcell` - This job has an custom aggregate task that combines a number of platform automation commands.  It checks to see if the desired stemcell and tile version have already been uploaded and staged.  If not, it downloads, stages, and assigns the stemcell
4. `configure-and-apply` - Configures the tile and selectively applies only changes to that product.  Again, uses a custom task.
5. `unlock-tile` - Releases the lock on the foundation.

The following notable configuration files exist:

- `enviornment/<iaas>/<foundation>/config` folder - Contains configuration files used by the pipeline.  Secret mappings are stored in the `secrets` folder and this directory has the credhub interpolate task run against it.
- `versions` - this folder contains `<product>.yml` and `<product>-stemcell.yml` files with configuration information for the product and its desired stemcell version
- `templates` - this folder contains the resulting interpolated template based on operations files that have been applied to the output of om config-template. This is created by scripts/generate-config.sh
- `defaults` - this folder contains the default values for a given tile. This is generated by om config-template
- `vars` - this folder contains environment specific variables per product that is being deployed.
- `secrets` - this folder contains the templates that can be interpolated using credhub interpolate to be used as secrets inputs to other tasks
- `versions` - this folder contains both the product version and stemcell version per product.

Following jobs within the `ad-hoc-jobs` group

1. `force-unlock` - Releases lock on the foundation.  Used when there is a failure at somepoint in the pipeline
2. `export-staged-config` - Exports the current staged config for the tile and puts it into the configured s3 bucket. This could be useful when you are first getting used to tile configuraiton and are unsure about optional and feature operations files

## Directory Structure

```ascii
├── environments
│   ├── vsphere
│   │   ├── foundation-1
│   │   │   ├── config-common
│   │   │   │   ├── secrets
│   │   │   │   │   └── env.yml
│   │   │   │   │   └── pivnet.yml
│   │   │   ├── config
│   │   │   │   ├── cf
│   │   │   │   │     cf-template.yml
│   │   │   │   │     cf-vars.yml
│   │   │   │   │     cf-defaults.yml
│   │   │   │   │     cf-secrets.yml
│   │   │   │   │     cf-version.yml
│   │   │   │   │     cf-stemcell-version.yml
│   │   │   │   │     cf-operation
│   │   │   │   └── ...
│   │   │   ├── config-director
│   │   │   │   ├── secrets
│   │   │   │   │   └── director.yml
│   │   │   │   │   └── opsman.yml
│   │   │   │   │   └── auth.yml
│   │   │   │   ├── templates
│   │   │   │   │   └── director.yml
│   │   │   │   │   └── opsman.yml
│   │   │   │   ├── vars
│   │   │   │   │   └── director.yml
│   │   │   │   │   └── opsman.yml
│   │   │   │   ├── versions
│   │   │   │   │   └── opsman.yml
│   │   │   ├── state
│   │   │   │   └── state.yml
├── pipelines
│   └── ...
├── proposed-tasks
│   └── ...
├── scripts
│   └── ...
```

## Automation Activities

### Setting up for a new tile

When creating configuration for a product for the first time

1. Configuration Setup
  1. Create `environments/<iaas>/<foundation>/config/<product> folder
  2. Go to pivnet and identify product version and stemcell version you want to use
  3. Copy <product>-version.yml and <product>-stemcell-version.yml from another products config directory and put it in new folder
  4. Update the version files appropriately
  5. Run `./scripts/generate-config.sh <product> <iaas>`.  This will generate tile-config folder for the product as well as operation, template, defaults, vars, and secreate files in the product folder
2. Customization
  1. Review features and options in the tile-config folder for the product
  2. Add desired features and options to the products operations file `<product>-operations`
  3. Re-run `./scripts/generate-config.sh <product> <iaas>`.  This will now update template and defaults files for the product
  4. Run `./scripts/validate-config.sh <product> <iaas> <foundation>`.  This will identify variables that need to be satisfied.
    1. Sensitive variables should be added to secrets file while referencing credhub credential name.
    2. Standard variables should be put into var file
  5. Review the default values.  Any values you want to override, add to the products vars file
  6. Re-run `./scripts/validate-config.sh <product> <iaas> <foundation>` to ensure all variables are satisfied
3. Credentials
  1. Add all required credentials into credhub
4. Deploy
  1. Commit the configuration changes and push to code repo
  2. Fly the pipeline
    1. fly standard-product-pipeline.yml passing in the product name.
    2. Update `./scripts/fly-pipelines.sh` script appropriately

>Note: There is a helper pipeline, `generate-certs-pipeline.yml`, to generate self-signed certs.

## Updating a version of a tile

1. Bump the versions
  1. Update the <product>-version.yml
  2. Update the <product>-stemcell-version.yml
2. Inspect Deferences
  1. Run `./scripts/validate-config.sh <product> <iaas> <foundation>`.  This may result in updated template, config, or default files.
  2. Identify if any changes were made via `git diff`
    1. Yes: manually review and make any necessary changes
    2. No: continue
  3. Run `./scripts/validate-config.sh <product> <iaas> <foundation>` to ensure all variables are satisfied
4. Deploy
  1. Commit the configuration changes and push to code repo